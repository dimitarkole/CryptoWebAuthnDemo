@using CryptoWebAuthnManager.Common
@{
    this.ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Welcome to @GlobalConstants.SystemName!</h1>
</div>


<input type="text" id="username" placeholder="Username" />
<button id="registerBtn">Register with WebAuthn</button>

<input type="text" id="loginUsername" placeholder="Username" />
<button id="loginBtn">Login with WebAuthn</button>


<script>
    document.getElementById("registerBtn").addEventListener("click", async () => {
       const username = document.getElementById("username").value;

        const response = await fetch(`/WebAuthn/RegisterOptions?username=${encodeURIComponent(username)}`, {
            method: "GET"
        });

        if (!response.ok) {
            const err = await response.text();
            alert("Error 1  : " + err);
            return;
        }

        const options = await response.json();

        options.challenge = base64UrlToUint8Array(options.challenge);
        options.user.id = base64UrlToUint8Array(options.user.id);

        if (options.excludeCredentials) {
            options.excludeCredentials = options.excludeCredentials.map(c => ({
                ...c,
                id: base64UrlToUint8Array(c.id)
            }));
        }

        try {

            const credential = await navigator.credentials.create({
                publicKey: options
            });

            const attestationResponse = {
                id: credential.id,
                rawId: arrayBufferToBase64(credential.rawId),
                type: credential.type,
                transports: ["usb"],
                response: {
                    attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                    clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
                }
            };

           const response = await fetch('/WebAuthn/RegisterComplete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attestationResponse)
            });
            const result = await response.json();
            if (result.success === true) {
                alert("Registration successful!");
            } else {
                alert("Registration failed!");
            }
        }
        catch (err) {
            alert("ERROR: " + err.name + " - " + err.message);
        }
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {

        const username = document.getElementById("loginUsername").value;

        // 1️⃣ Взимаме assertion options от сървъра
        const response = await fetch("/WebAuthn/LoginOptions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: username
            })
        });

        if (!response.ok) {
            alert("Error getting login options");
            return;
        }

        const options = await response.json();
        options.challenge = base64UrlToUint8Array(options.challenge);

        if (options.allowCredentials) {
            options.allowCredentials = options.allowCredentials.map(c => ({
                  type: "public-key",
                id: base64UrlToUint8Array(c.id)
            }));
        }

        try {
           /* const authData = {
                id: assertion.id,
                rawId: arrayBufferToBase64Url(assertion.rawId),
                type: assertion.type,
                transports: null,
                response: {
                    authenticatorData: arrayBufferToBase64Url(assertion.response.authenticatorData),
                    clientDataJSON: arrayBufferToBase64Url(assertion.response.clientDataJSON),
                    signature: arrayBufferToBase64Url(assertion.response.signature),
                    userHandle: assertion.response.userHandle
                        ? arrayBufferToBase64Url(assertion.response.userHandle)
                        : null
                },
                clientExtensionResults: assertion.getClientExtensionResults()
            };*/

                // 4️⃣ Викаме authenticator
                const assertion = await navigator.credentials.get({
                    publicKey: options
                });

                // 5️⃣ Превръщаме всичко в JSON за C# модела
                const authData = {
                    id: assertion.id,
                    rawId: arrayBufferToBase64Url(assertion.rawId),
                    type: assertion.type, // "public-key"
                    response: {
                        authenticatorData: arrayBufferToBase64Url(assertion.response.authenticatorData),
                        clientDataJSON: arrayBufferToBase64Url(assertion.response.clientDataJSON),
                        signature: arrayBufferToBase64Url(assertion.response.signature),
                        userHandle: assertion.response.userHandle
                            ? arrayBufferToBase64Url(assertion.response.userHandle)
                            : null
                    },
                    clientExtensionResults: {} // празен обект
                };

                // 6️⃣ Изпращаме към сървъра
                const verifyResponse = await fetch("/WebAuthn/LoginComplete", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(authData)
                });

                if (verifyResponse.ok) {
                    alert("Login successful!");
                } else {
                    const err = await verifyResponse.text();
                    alert("Login failed: " + err);
                }

            } catch (err) {
                alert("ERROR: " + err.name + " - " + err.message);
            }
    });

       function base64UrlToUint8Array(base64Url) {
        const padding = "=".repeat((4 - base64Url.length % 4) % 4);
        const base64 = (base64Url + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    function arrayBufferToBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function base64UrlToUint8Array(base64Url) {
        const padding = "=".repeat((4 - base64Url.length % 4) % 4);
        const base64 = (base64Url + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }

        return outputArray;
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }
</script>