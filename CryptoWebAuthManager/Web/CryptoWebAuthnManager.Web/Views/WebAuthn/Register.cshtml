<h2>WebAuthn Registration</h2>

<input type="text" id="username" placeholder="Username" />
<button id="registerBtn">Register with WebAuthn</button>

<script>
document.getElementById("registerBtn").addEventListener("click", async () => {
   const username = document.getElementById("username").value;

    const response = await fetch(`/WebAuthn/RegisterOptions?username=${encodeURIComponent(username)}`, {
        method: "GET"
    });

    if (!response.ok) {
        const err = await response.text();
        alert("Error 1  : " + err);
        return;
    }

    const options = await response.json();

    options.challenge = base64UrlToUint8Array(options.challenge);
    options.user.id = base64UrlToUint8Array(options.user.id);

    if (options.excludeCredentials) {
        options.excludeCredentials = options.excludeCredentials.map(c => ({
            ...c,
            id: base64UrlToUint8Array(c.id)
        }));
    }
    
    try {

        const credential = await navigator.credentials.create({
            publicKey: options
        });

        const attestationResponse = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            type: credential.type,
            transports: ["usb"],
            response: {
                attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
            }
        };

       const response = await fetch('/WebAuthn/RegisterComplete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(attestationResponse)
        });
        const result = await response.json();
        if (result.success === true) {
            alert("Registration successful!");
        } else {
            alert("Registration failed!");
        }
    }
    catch (err) {
        alert("ERROR: " + err.name + " - " + err.message);
    }
});

function base64UrlToUint8Array(base64Url) {
    const padding = "=".repeat((4 - base64Url.length % 4) % 4);
    const base64 = (base64Url + padding)
        .replace(/-/g, "+")
        .replace(/_/g, "/");

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }

    return outputArray;
}

function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}
</script>